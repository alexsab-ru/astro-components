# 🔄 Диаграмма работы системы отслеживания форм

## 📊 Общий поток работы

```
┌─────────────────────────────────────────────────────────────────┐
│                    Пользователь открыл сайт                      │
└───────────────────────────────┬─────────────────────────────────┘
                                │
                                ↓
                    ┌───────────────────────┐
                    │  UserActivityTracker  │
                    │   инициализируется    │
                    └───────────┬───────────┘
                                │
                    ┌───────────┴───────────┐
                    │  Проверка localStorage │
                    └───────────┬───────────┘
                                │
                    ┌───────────┴────────────┐
                    │ Прошло > 30 минут?     │
                    └───┬────────────────┬───┘
                        │ ДА             │ НЕТ
                        ↓                ↓
              ┌─────────────────┐   ┌──────────────────┐
              │ Увеличить визит │   │ Оставить прежним │
              │ visit_count++   │   │                  │
              └─────────────────┘   └──────────────────┘
```

## 📝 Поток отправки формы

```
┌─────────────────────────────────────────────────────────────────┐
│            Пользователь заполнил и отправил форму                │
└───────────────────────────────┬─────────────────────────────────┘
                                │
                                ↓
                        ┌───────────────┐
                        │  Валидация    │
                        │ FormsValidation│
                        └───────┬───────┘
                                │
                    ┌───────────┴───────────┐
                    │ Форма валидна?        │
                    └───┬───────────────┬───┘
                        │ ДА            │ НЕТ
                        ↓               ↓
                        │         ┌──────────────┐
                        │         │ Показать     │
                        │         │ ошибки       │
                        │         └──────────────┘
                        │         КОНЕЦ ❌
                        ↓
            ┌───────────────────────┐
            │ EnhancedFormsIntegration│
            │   перехватил submit    │
            └───────────┬───────────┘
                        │
                        ↓
            ┌───────────────────────┐
            │ Проверка блокировки   │
            │ (1 час после отправки)│
            └───────┬───────────────┘
                    │
        ┌───────────┴───────────┐
        │ Заблокирована?        │
        └───┬───────────────┬───┘
            │ ДА            │ НЕТ
            ↓               ↓
    ┌────────────────┐      │
    │ Показать окно: │      │
    │ "Уже отправили"│      │
    │ Осталось: XX мин│     │
    └────────────────┘      │
    КОНЕЦ ❌                │
                            ↓
                ┌───────────────────────┐
                │ Есть успешные отправки?│
                └───┬───────────────┬───┘
                    │ ДА            │ НЕТ
                    ↓               ↓
    ┌──────────────────────────┐   │
    │ Показать модальное окно: │   │
    │ "Повторная заявка?"      │   │
    └───┬──────────────────┬───┘   │
        │                  │       │
    ┌───┴───┐         ┌────┴────┐ │
    │ "Да"  │         │ "Отмена"│ │
    └───┬───┘         └────┬────┘ │
        │                  │       │
        │                  ↓       │
        │          ┌───────────┐   │
        │          │ Сброс     │   │
        │          │ формы     │   │
        │          └───────────┘   │
        │          КОНЕЦ ❌        │
        │                          │
        ↓                          │
    ┌───────────────────┐          │
    │ Установить флаг:  │          │
    │ repeat_confirmed=1│          │
    └───────┬───────────┘          │
            │                      │
            └──────────┬───────────┘
                       │
                       ↓
        ┌──────────────────────────┐
        │ Увеличить счётчики:      │
        │ - submit_attempts++      │
        └──────────┬───────────────┘
                   │
                   ↓
        ┌──────────────────────────┐
        │ ConnectFormsWrapper      │
        │ добавляет данные:        │
        │ - user_visit_count       │
        │ - user_submit_attempts   │
        │ - user_successful_submits│
        │ - user_repeat_confirmed  │
        └──────────┬───────────────┘
                   │
                   ↓
        ┌──────────────────────────┐
        │ Отправка на сервер       │
        │ (fetch POST)             │
        └──────────┬───────────────┘
                   │
        ┌──────────┴──────────┐
        │ Ответ от сервера    │
        └──┬────────────────┬─┘
           │ SUCCESS        │ ERROR
           ↓                ↓
┌─────────────────────┐  ┌──────────────┐
│ - Показать "Спасибо"│  │ Показать     │
│ - successful_submit++│  │ ошибку       │
│ - Установить        │  └──────────────┘
│   last_submit_time  │
│ - Блокировка на 1ч  │
└─────────────────────┘
    КОНЕЦ ✅
```

## 🕐 Временная шкала событий

```
t=0          Первый визит
             ↓
             visit_count = 1
             
t=10 мин     Отправка формы #1
             ↓
             successful_submits = 1
             БЛОКИРОВКА на 60 минут
             
t=20 мин     Попытка отправки #2
             ↓
             ❌ БЛОКИРОВАНО
             "Осталось 50 минут"
             
t=70 мин     Попытка отправки #3
             ↓
             ⚠️ Модальное окно
             "Повторная заявка?"
             ↓
             [Пользователь нажал "Да"]
             ↓
             successful_submits = 2
             repeat_confirmed = 1
             БЛОКИРОВКА снова на 60 минут
             
t=120 мин    Попытка отправки #4
             ↓
             ❌ БЛОКИРОВАНО
             "Осталось 10 минут"

t=30 часов   Новый визит
             ↓
             visit_count = 2
```

## 💾 Состояние localStorage

```
┌────────────────────────────────────────────────┐
│             localStorage                       │
├────────────────────────────────────────────────┤
│                                                │
│  user_visit_count           → 3                │
│  user_last_visit_time       → 1729512345678    │
│                                                │
│  user_submit_attempts       → 5                │
│  user_successful_submits    → 2                │
│  user_last_submit_time      → 1729512300000    │
│  user_repeat_submit_confirmed → 1              │
│                                                │
└────────────────────────────────────────────────┘
                    │
                    ↓
        ┌───────────────────────┐
        │  При отправке формы:  │
        │                       │
        │  FormData включает:   │
        │  - все поля формы     │
        │  + данные из storage  │
        └───────────────────────┘
```

## 🎯 Логика принятия решений

```
┌──────────────────────────────────────────────────────────────┐
│                     ДЕРЕВО РЕШЕНИЙ                           │
└──────────────────────────────────────────────────────────────┘

Попытка отправки формы
         │
         ↓
    Валидна? ──НЕТ──→ Показать ошибки валидации ❌
         │
        ДА
         ↓
    last_submit_time существует?
         │
         ├──НЕТ──→ [Первая отправка] ──→ Отправить ✅
         │
        ДА
         ↓
    (now - last_submit_time) < 1 час?
         │
         ├──ДА──→ Показать блокировку ❌
         │        "Подождите XX минут"
         │
        НЕТ
         ↓
    successful_submits > 0?
         │
         ├──НЕТ──→ [Нет истории] ──→ Отправить ✅
         │
        ДА
         ↓
    repeat_confirmed == 1?
         │
         ├──ДА──→ [Уже подтвердил] ──→ Отправить ✅
         │                              + установить repeat_confirmed=1
         │
        НЕТ
         ↓
    Показать модальное окно
    "Повторная заявка?"
         │
         ├──"Отмена"──→ Сброс формы ❌
         │
         └──"Да"──→ Установить repeat_confirmed=1
                    │
                    ↓
                   Отправить ✅
```

## 🧩 Взаимодействие модулей

```
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│                      app.js (main)                          │
│                                                             │
└─────────────┬───────────────────────────────────────────────┘
              │
              │ импортирует и инициализирует
              │
    ┌─────────┼─────────┬─────────────┬──────────────────┐
    │         │         │             │                  │
    ↓         ↓         ↓             ↓                  ↓
┌─────────┐ ┌────┐ ┌────────┐ ┌──────────────┐ ┌────────────────┐
│Enhanced │ │User│ │Custom  │ │ConnectForms  │ │FormTracking    │
│Forms    │→│Act.│←│Forms   │ │Wrapper       │ │Debug           │
│Integr.  │ │Tra.│ │Handler │ │              │ │                │
└────┬────┘ └─┬──┘ └───┬────┘ └──────┬───────┘ └────────────────┘
     │        │        │              │
     │ использует      │ использует   │
     └────────┼────────┘              │
              │                       │
              │  перехватывает        │
              └───────────────────────┘
                     fetch()
```

## 🔄 Полный цикл пользовательского взаимодействия

```
1. ВХОД НА САЙТ
   └─→ UserActivityTracker.initVisitTracking()
       └─→ Проверка времени последнего визита
           └─→ Обновление visit_count если нужно

2. ЗАПОЛНЕНИЕ ФОРМЫ
   └─→ Валидация полей в реальном времени
       └─→ FormsValidation.validate()

3. НАЖАТИЕ "ОТПРАВИТЬ"
   └─→ Event 'submit' перехватывается
       └─→ EnhancedFormsIntegration.handleFormSubmit()
           │
           ├─→ Проверка блокировки
           │   └─→ UserActivityTracker.checkIfBlocked()
           │
           ├─→ Проверка необходимости подтверждения
           │   └─→ CustomFormsHandler.checkAndShowConfirmModal()
           │
           └─→ Увеличение счётчика попыток
               └─→ UserActivityTracker.incrementSubmitAttempts()

4. ОТПРАВКА НА СЕРВЕР
   └─→ ConnectFormsWrapper перехватывает fetch
       └─→ Добавляет данные активности в FormData
           └─→ Оригинальный fetch выполняется

5. ОТВЕТ ОТ СЕРВЕРА
   └─→ Success callback вызывается
       └─→ UserActivityTracker.incrementSuccessfulSubmits()
           └─→ Установка last_submit_time (блокировка на час)
               └─→ Сброс repeat_confirmed флага

6. ПОКАЗ СООБЩЕНИЯ
   └─→ Модальное окно "Спасибо!"
       └─→ Форма сбрасывается
```

## 🎨 Визуализация модальных окон

```
┌────────────────────────────────────────┐
│           БЛОКИРОВКА (1 час)           │
├────────────────────────────────────────┤
│                                        │
│   🚫                                   │
│                                        │
│   Заявка уже отправлена                │
│                                        │
│   Вы уже отправили заявку.             │
│   С Вами обязательно свяжутся в        │
│   ближайшее рабочее время!             │
│                                        │
│   Повторная отправка будет доступна    │
│   через 45 мин.                        │
│                                        │
│   ┌──────────┐                         │
│   │ Закрыть  │                         │
│   └──────────┘                         │
└────────────────────────────────────────┘


┌────────────────────────────────────────┐
│      ПОДТВЕРЖДЕНИЕ ПОВТОРНОЙ ОТПРАВКИ  │
├────────────────────────────────────────┤
│                                        │
│   ⚠️  Повторная заявка?                │
│                                        │
│   Вы уже отправляли заявку ранее.      │
│   Действительно хотите отправить ещё   │
│   одну?                                │
│                                        │
│   ┌───────────────┐  ┌──────────┐      │
│   │ Да, отправить │  │ Отмена   │      │
│   └───────────────┘  └──────────┘      │
└────────────────────────────────────────┘
         │                    │
         ↓                    ↓
    Отправить            Сброс формы
    + flag=1                ❌
       ✅
```

## 📈 Сценарии использования

### Сценарий A: Нормальный пользователь
```
День 1:  Визит → Отправка → Блокировка 1ч
День 2:  Визит → Отправка → Подтверждение → Успех
День 3:  Визит → Просмотр (без отправки)
```

### Сценарий B: Спамер
```
t=0:     Визит → Отправка → Блокировка 1ч
t=5мин:  Попытка → ❌ БЛОКИРОВКА
t=10мин: Попытка → ❌ БЛОКИРОВКА
t=15мин: Попытка → ❌ БЛОКИРОВКА
...
Все попытки заблокированы ✅
```

### Сценарий C: Законная повторная заявка
```
Неделю назад: Отправка заявки #1
Сегодня:      Новая заявка
              ↓
              Модальное окно
              ↓
              Подтверждение
              ↓
              Отправка с flag=1
              ↓
              Сервер видит что это осознанная повторная заявка ✅
```

---

**Легенды:**
- ✅ = Успешное выполнение
- ❌ = Блокировка / Ошибка
- ⚠️ = Требуется подтверждение
- → = Переход к следующему шагу
- ↓ = Вертикальный поток

