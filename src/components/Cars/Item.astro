---
interface Props {
	car: any;
	path?: string;
	slug?: string;
	totalShow?: boolean;
}
const {car = {}, path = '/cars/', slug, totalShow = true, ...rest} = Astro.props;
// Формируем URL по приоритету: переданный slug | внутренний путь по id
const url = slug ? slug : `${path}${car.id}/`;

import { calculateCarPrice, getModelBadgeData } from '@/js/utils/car.utils';
// Подсказка: при необходимости можно отдельно получить модель через findModelByCarData(car.data).
// Теперь мы тянем сразу картинку и alt в одном месте, чтобы не повторять поиск модели.
const { image: badgeImage, alt: badgeAlt } = getModelBadgeData(car.data);
const price = calculateCarPrice(car.data);

import { declOfNums, currencyFormat } from '@/js/utils/numbers.format';
import PreviewSlider from './PreviewSlider.astro';
import Button from '@/components/Button/Button.astro';

import salonsData from '@/data/salons.json';
import type { ISalon } from '@/types/ISalon';
const salons = salonsData.filter((salon: ISalon) => !salon?.type || salon?.type.includes('common_modal'));
---

<div 
	class="car-item flex flex-col justify-between shadow-2xl pb-3 xl:pb-4 relative" 
	data-price={ price } 
	data-brand={ car.data.mark_id.replace(',', '') } 
	data-model={ car.data.folder_id.replace(',', '') } 
	data-color={ car.data?.color } 
	data-complectation={ car.data?.complectation_name } 
	data-engine={ `${car.data?.engine} (${car.data?.enginePower} л.с.)` } 
	data-drive={ car.data?.drive } 
	data-order={ car.data?.order } 
	data-year={ car.data?.year } 
	data-total={ car.data.total }
	data-max-discount={ car.data?.max_discount }
	{...rest}
>
	<PreviewSlider car={car} url={url} />
	<div class="grow mb-3 md:mb-5 px-3 xl:px-4 flex flex-col justify-end">
		{ car.data.max_discount ? (
			<noindex><div class="discount">с&nbsp;учетом выгоды до&nbsp;<span class="font-semibold">{ currencyFormat(car.data.max_discount) }</span></div></noindex>
		): ('')}
		<div class="sm:text-lg md:text-xl xl:text-3xl font-medium mt-3"><span class="text-sm text-gray-400">от</span>&nbsp;{currencyFormat(price)}</div>
		<h2 class="xs:text-xs! sm:text-base! md:text-lg! xl:text-xl! mt-1 mb-0! transition-colors hover:text-accent grow ml-0! mr-0! p-0! before:hidden!">
			<a href={ url } class="no-underline! text-black! mb-0!"><b class="font-bold">{ car.data.mark_id } { car.data.folder_id }</b> { car.data.complectation_name }</a>
		</h2>
		{car.data?.color && (<small class="text-gray-700">{car.data.color}</small>)}
		<noindex><div class="text-xs sm:text-sm md:text-base mt-0.5 sm:mt-1 text-gray-400">
			{ car.data.modification_id }{ car.data?.year && ` · ${car.data.year}` }
			{car.data.run ? <Fragment set:html={`&nbsp;/&nbsp;${car.data.run}&nbsp;км`} /> : ''}
		</div></noindex>
		{(car.data.total && totalShow) && (<div class="text-xs sm:text-sm md:text-base mt-0.5 sm:mt-1 text-gray-900">{ car.data.total } {declOfNums(car.data.total)}</div>)}
		{badgeImage && (<img src={badgeImage} class="absolute right-3 top-3 xs:right-1 xs:top-1 z-10 xs:h-12 h-16 lg:h-20 xl:h-24 w-auto" alt={badgeAlt} />)}
	</div>
	<div class="px-3 xl:px-4 flex flex-wrap justify-between gap-y-2 sm:gap-y-3">
		<Button 
			classes="popup-link black block px-2! py-2! md:text-base! sm:text-sm! text-xs! text-white! no-underline! mb-0! w-full md:w-[48%]" 
			url="#common-modal" 
			title="Купить"
			dataTitle={`Купить ${ car.data.mark_id } ${car.data?.folder_id}`}
			dataFormName={`Купить. ${car.data?.color} ${ car.data.mark_id } ${car.data?.folder_id} ${car.data?.complectation_name} ${car.data?.modification_id}, ${car.data?.vin}. ${currencyFormat(car.data.price)}`}
			{...salons.length > 1 ? {'data-filtering': car.data.mark_id} : {}}
		/>
		<Button 
			classes="popup-link gray block px-2! py-2! md:text-base! sm:text-sm! text-xs! text-white! no-underline! mb-0! w-full md:w-[48%]" 
			url="#common-modal" 
			title="Кредит"
			dataTitle={`Рассчитать кредит ${ car.data.mark_id } ${car.data?.folder_id}`}
			dataFormName={`Рассчитать кредит. ${car.data?.color} ${ car.data.mark_id } ${car.data?.folder_id} ${car.data?.complectation_name} ${car.data?.modification_id}, ${car.data?.vin}. ${currencyFormat(car.data.price)}`}
			{...salons.length > 1 ? {'data-filtering': car.data.mark_id} : {}}
		/>
		<Button 
			classes="popup-link black btn-o block px-2! py-2! md:text-base! sm:text-sm! text-xs! no-underline! mb-0! w-full md:w-[48%]" 
			url="#common-modal" 
			title="Рассрочка"
			dataTitle={`Рассрочка на ${ car.data.mark_id } ${car.data?.folder_id}`}
			dataFormName={`Рассрочка. ${car.data?.color} ${ car.data.mark_id } ${car.data?.folder_id} ${car.data?.complectation_name} ${car.data?.modification_id}, ${car.data?.vin}. ${currencyFormat(car.data.price)}`}
			{...salons.length > 1 ? {'data-filtering': car.data.mark_id} : {}}
		/>
		<Button 
			classes="block px-2! py-2! md:text-base! sm:text-sm! text-xs! no-underline! mb-0! text-white! w-full md:w-[48%]" 
			url={ url }
			view="link"
			title="Подробнее"
		/>
	</div>
</div>