---
import Layout from '@/layouts/Layout.astro';
import Banner from '@/components/Banner/Banner.astro';
import SpecialServices from '@/components/SpecialServices/Index.astro';
import Faq from '@/components/Faq/Index.astro';
import NewServices from '@/components/Services/New.astro';
import ReviewsSlider from '@/components/Reviews/Index.astro';
import settings from '@/data/settings.json';
const { site_name, brand, legal_city_where } = settings;
import {TIMER, MARQUEE, REVIEWS_LIMIT} from '@/const.js';
import PageH1 from '@/components/PageH1/Index.astro';
import Timer from '@/components/Timer/Timer.astro';
import ModelList from '@/components/Model/ModelList.astro';
import LatestPosts from '@/components/LatestPosts/Index.astro';
import Model from '@/components/Model/Model.astro';
import ModelComplectations from '@/components/Model/Complectations.astro';
import Callback from '@/components/Callback.astro';
import Services from '@/components/Services.astro';
import Contacts from '@/components/Contacts.astro';
import Morquee from '@/components/Marquee/Index.astro';

import modelsData from '@/data/models.json'
const { models } = modelsData;

import salonsData from '@/data/salons.json';
import type { ISalon } from '@/types/ISalon';
const salons = salonsData.filter((salon: ISalon) => !salon?.type || salon?.type.includes('index'));
const modelsWithComplectations = models.filter(m => (m?.complectations !== undefined && m?.complectations.length));
import specialServicesData from '@/data/special-services.json'
import faqData from '@/data/faq.json'
import servicesData from '@/data/services.json'
import allReviewsData from '@/data/reviews.json'

const reviewsData = allReviewsData.slice(0, REVIEWS_LIMIT);

const salonsPhone = salons.map((salon: any) => salon.phone).filter(phone => phone).join(', ');
import SeoText from '@/components/Seo/Index.astro';

import FaqItem from '@/components/Faq/Item.astro';
import { type TFaqItem } from '@/components/Faq/types';
import Table from '@/components/Table/Table.astro';
import CalcBar from '@/components/CalcBar/CalcBar.astro';

// Парсим JSON и готовим данные для заголовков аккордеона + таблиц.
//
// ВАЖНО:
// - Файл `src/data/dealer-service-price.json` опциональный.
// - Прямой `import` упадет в сборке, если файла нет.
// - Через `import.meta.glob` получаем модуль, только если файл реально есть.
const servicesModules = import.meta.glob('/src/data/dealer-service-price.json', { eager: true });
const servicesJsonData = (Object.values(servicesModules)[0] as any)?.default ?? [];

let faqBlocks = [];

if (Array.isArray(servicesJsonData)) {
	// Группируем услуги по типу
	const servicesGrouped: Record<string, any[]> = {};
	servicesJsonData.forEach((service: any) => {
		const type = service['Тип'];
		if (!servicesGrouped[type]) {
			servicesGrouped[type] = [];
		}
		servicesGrouped[type].push(service);
	});

	// Создаем faqBlocks для использования в компоненте FaqItem + Table
	faqBlocks = Object.entries(servicesGrouped).map(([type, services], index) => {
		// Создаем item для FaqItem (заголовок аккордеона)
		const item: TFaqItem = {
			id: index,
			question: type,  // Название типа услуги (например, "Диагностика")
			answer: '',  // Не используется, т.к. контент будет таблицей
			open: false  // По умолчанию аккордеон закрыт
		};
		
		// Создаем rows для Table (данные таблицы)
		// Фильтруем услуги: показываем только те, у которых есть цена.
		//
		// ВАЖНО (почему тут нельзя `service['цена от'] !== null`):
		// - В JSON цена может быть:
		//   - null (явно нет цены)
		//   - undefined (поля нет вообще / другое название ключа)
		// - Проверка `!== null` НЕ отсекает undefined.
		//   Тогда дальше падаем на `undefined.toLocaleString(...)`.
		// - Из-за внешнего try/catch ошибка “прячется”, и `faqBlocks` становится пустым,
		//   а секция "Наши услуги" пропадает целиком.
		//
		// Поэтому:
		// - Берём цену из нескольких возможных ключей.
		// - Используем `!= null`, чтобы отсеять и null, и undefined.
		// - Дополнительно проверяем, что это конечное число (иначе просто исключаем строку).
		const rows = services
			.map((service) => {
				// Поддерживаем несколько вариантов ключа цены (данные приходят не всегда идеально).
				const rawPrice =
					service?.['цена от'] ??
					service?.['Цена от'] ??
					service?.['Цена'] ??
					undefined;

				// Отсекаем null и undefined одной проверкой.
				if (rawPrice == null) return null;

				// Приводим цену к числу безопасно:
				// - Если это число — берём как есть.
				// - Если это строка — вытаскиваем цифры (на случай "6 000", "6000 руб." и т.п.).
				const priceNumber =
					typeof rawPrice === 'number'
						? rawPrice
						: typeof rawPrice === 'string'
							? Number(rawPrice.replace(/\D/g, ''))
							: Number(rawPrice);

				// Если цена не число — выкидываем строку.
				if (!Number.isFinite(priceNumber)) return null;

				return {
					name: service?.['Работы'] ?? '', // Наименование работы
					// Форматируем цену по российским стандартам (например: 456 000)
					price: priceNumber.toLocaleString('ru-RU'),
				};
			})
			.filter(Boolean);
		
		return { item, rows };
	})
	.filter(({ rows }) => rows.length > 0);  // Исключаем группы без услуг с ценами
}
---

<Layout title=`Купить ${brand} у официального дилера ${site_name}` description=`Забронируйте свой автомобиль прямо сейчас у официального дилера ${brand} в ${legal_city_where}! ☎️ ${salonsPhone}`>
	<Banner />
	{ MARQUEE.show && <Morquee marquee={ MARQUEE } /> }
	<section class="ptop-[2.7] pbottom-[2.5] bg-accent-500">
		<div class="container">
			<PageH1 h1=`Автосервис ${brand} в&nbsp;${legal_city_where}` classes="text-center fz-3 text-white leading-none" />
		</div>
	</section>
	{/*
		Timer ожидает Date, а в `src/const.js` endtime хранится строкой (ISO).
		Явно конвертируем строку в Date здесь, чтобы TypeScript не ругался и поведение было очевидным.
	*/}
	{ TIMER.show && <Timer endtime={new Date(TIMER.endtime)} title={TIMER.title} subtitle={TIMER.subtitle} btnName={TIMER.btnName} /> }
	{ specialServicesData && <SpecialServices items={specialServicesData} /> }
	{ faqBlocks.length > 0 && (
		<section class="faq container mt-10" id="services-faq" x-data="{activities:[]}">
			<h2 class="mb-8 sm:mb-14">Наши услуги</h2>
			{ faqBlocks.map(({ item, rows }) => (
				<FaqItem item={item} centerTitle={true}>
					<div class="content">
						{/*
							Передаём `calcGroup`, чтобы одинаковые услуги из разных аккордеонов
							не конфликтовали в хранилище (ключ строится по group+title+price).
						*/}
						<Table
							data={rows}
							calc={true}
							calcGroup={item.question}
							head={['Наименование', 'Цена, руб.']}
							tableLoyoutFixed={true}
						/>
					</div>
				</FaqItem>
			))}
			<CalcBar />
		</section>
	)}
	<LatestPosts collectionName="actions" title="Специальные предложения" id="specials" class="bg-gray-100" />
	{ servicesData && <NewServices items={servicesData} title="Услуги сервисного центра" id="new-services" show={false} /> }
	{ faqData && <Faq items={faqData} title="Часто задаваемые вопросы" class="bg-gray-100" /> }
	<Callback bgUrl="https://cdn.alexsab.ru/b/alpha-center/img/konkurenty.webp" />
	{ reviewsData && <ReviewsSlider items={reviewsData} title="Отзывы о нас" class="bg-gray-100" /> }
	<Services />
	<SeoText mdx="index" />
	<Contacts />
</Layout>
