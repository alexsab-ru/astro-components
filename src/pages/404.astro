---
import Layout from '@/layouts/Layout.astro';
import PostItem from '@/components/Post/Item.astro';
import CarItem from '@/components/Cars/Item.astro';
import PageH1 from '@/components/PageH1/Index.astro';
const title = 'Ошибка 404';
const description = '404. Такая страница не найдена';
const h1 = '404. Такая страница не найдена';
import { getCollection } from 'astro:content';
// Фильтруем записи коллекций на 404, чтобы исключить тестовые/черновые/просроченные
import { sortingAndFilteringPosts } from '@/js/utils/sortingAndFilteringPosts';
const cars = await getCollection('cars');
// Получаем все записи спецпредложений и применяем единую фильтрацию
const specialAll = await getCollection('special-offers');
const special = sortingAndFilteringPosts(specialAll);
// if(Astro.url.pathname.slice(-1) != "/") {
	// return Astro.redirect(Astro.url.pathname+'/', 308);
// }
---

<Layout title={title} description={description}>
	<section class="relative pb-10 px-5">
		<div class="flex flex-col items-center justify-center gap-5 sm:gap-10 px-2">
			<div class="text-lg sm:text-3xl md:text-4xl lg:text-6xl text-center">
				<PageH1 h1={h1} classes="uppercase" />
			</div>
			<div class="flex gap-4 flex-wrap mt-5">
				<a href="/" class="btn btn-o inline-block">На главную страницу</a>
				<a href="/" class="btn inline-block" id="btn-back">Назад</a>				
			</div>
		</div>
		<img src="https://cdn.alexsab.ru/errors/404wt.webp" class="max-w-xl w-full mx-auto mt-10" alt="not found" width="576" height="384" loading="lazy" />
	</section>
	<section class="relative pb-10 hidden" id="more">
		<div class="container">
			<h2 class="mb-10">Смотрите также:</h2>
			{(cars && cars.length > 0) && (
				<div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-3 xl:grid-cols-4 gap-3 sm:gap-5 mt-5 car-list hidden" id="cars_more">
					{cars.map((car) => <CarItem car={car} />)}
				</div>
			)}
			{(special && special.length > 0) && (
				<div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-5 hidden" id="special-offers_more">
					{special.map((post) => <PostItem post={post} />)}
				</div>
			)}
		</div>
	</section>
</Layout>

<script>
	const items = ['cars', 'special-offers']
	const parent = document.getElementById('more');
	items.map(item => {
		const match = `/${item}/`;
		if (window.location.pathname.includes(match)){
			const elem = document.getElementById(item+'_more');
			if(elem){
				elem.classList.remove('hidden');
				parent.classList.remove('hidden');
			}
		}
	});

	// Подставляем ссылку "Назад" на раздел выше: /models/1111 -> /models/
    function setBackHref() {
        const backBtn = document.querySelector('#btn-back[href]');
        if (!backBtn) return;

        const pathname = window.location.pathname || '/';
        const normalizedPath = pathname.endsWith('/') && pathname.length > 1 
            ? pathname.slice(0, -1) 
            : pathname;
        
        const lastSlashIndex = normalizedPath.lastIndexOf('/');
        backBtn.href = lastSlashIndex <= 0 ? '/' : normalizedPath.slice(0, lastSlashIndex + 1);
    }

    setBackHref();
</script>