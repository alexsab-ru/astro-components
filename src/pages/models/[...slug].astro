---
import Layout from '@/layouts/Layout.astro';
import Model from '@/components/Model/Model.astro';
import ModelComplectations from '@/components/Model/Complectations.astro';
import CarItem from "@/components/Cars/Item.astro";
import UniversalSection from '@/components/Model/sections/universal.astro';
import FeedbackForm from '@/components/FeedbackForm/FeedbackForm.astro';
import SeoText from '@/components/Seo/Index.astro';
import PageH1 from '@/components/PageH1/Index.astro';
const { slug } = Astro.params;

const seoname = 'models-'+slug;


import modelsData from '@/data/models.json';
import { isModelVisible } from '@/js/utils/modelVisibility';
import { normalizeModelId } from '@/js/utils/normalizeModelId';
import { getModelSectionsYML, setPrefixModelUrl } from '@/js/utils/helpers';
import { IS_MODEL_PREFIX_URL } from '@/const';
export async function getStaticPaths() {
  const { models } = modelsData;
  return models.filter(isModelVisible).map((model) => {
    return {
      params: { slug: setPrefixModelUrl(model, IS_MODEL_PREFIX_URL) },
      props: { model },
    };
  });
}


import settings from '@/data/settings.json';
const { legal_city_where } = settings;
import { getRandomInt } from '@/js/utils/numbers.format';
import { breadcrumb } from './index.astro';
const { model } = Astro.props;

// Данные для сохранения "последней просмотренной модели" в Alpine store
const lastViewedModelForStore = {
  idNormalized: normalizeModelId(model.id),
  markId: model.mark_id,
};
const lastViewedModelJSON = JSON.stringify(lastViewedModelForStore);

import { getCollection, type DataEntryMap } from "astro:content";
const rawCars = await getCollection("cars" as keyof DataEntryMap);
const cars = rawCars && rawCars.length ? rawCars
  .filter(car => !(typeof car.id === 'string' && car.id.startsWith('__')))
  .filter((car) => {
    const carMark = car.data.mark_id.toLowerCase();
    const modelMark = model.mark_id.toLowerCase();
    const carFolder = normalizeModelId(car.data.folder_id);
    const modelId = normalizeModelId(model.id);
    const feedNames = Array.isArray((model as any)?.feed_names) ? (model as any).feed_names : [];
    return carMark === modelMark && (carFolder === modelId || feedNames.includes(car.data.folder_id));
  })
: [];
import salonsData from '@/data/salons.json';
import type { ISalon } from '@/types/ISalon';
const salons = salonsData.filter((salon: ISalon) => !salon?.type || salon?.type.includes('index'));
const salonsPhone = salons.map((salon: any) => salon.phone).filter(phone => phone).join(', ');

import {STATUS} from '@/const';
import type { TStatus } from '@/types/TStatus';

const status: TStatus = (model?.status && STATUS.includes(model.status as TStatus)) ? model.status : 'enable';

// Загружаем YML файл модели из директории model-sections 
let sections = await getModelSectionsYML(model);
---
<Layout 
  title={`${model.mark_id} ${model.name} – фото, цены, комплектации и характеристики ${model.mark_id} ${model.name} в ${legal_city_where}`} 
  description={`${model.mark_id} ${model.name} купить в ${legal_city_where}. Кредит, авторассрочка, скидки на все автомобили от розничной цены. Гарантия. Звонить по тел.: ${salonsPhone}`}
  image={(model as any).image ?? (model as any).thumb}
  brand={model.mark_id}
>
  <div x-init={`$store.lastViewedModel.setModel(${lastViewedModelJSON})`} class="hidden"></div>
  <PageH1 h1={`Автомобиль ${model?.mark_id} ${model.name} в ${legal_city_where}`} classes="sr-only" />
  <Model model={model} status={status} breadcrumb={[breadcrumb, {name: model.name, href: Astro.url.pathname}]} />
  {
    !!sections.length && sections.map(s => ( <UniversalSection section={s} /> ))
  }
  {
    ((model as any)?.complectations && (model as any).complectations !== undefined && !!(model as any).complectations.length) && <ModelComplectations title={`Подобрать комплектацию ${model?.mark_id} ${model.name}`} model={model} brand={model?.mark_id} />
  }
  <SeoText mdx={seoname} sectionPaddingBlock />

  {(status === 'enable' || status === 'show') && (
    <section>
      <div class="container">
        <FeedbackForm 
          title="Записаться на тест-драйв" 
          imageUrl={sections.length > 0
            ? (sections[0]?.images && sections[0].images.length > 0 ? sections[0].images[0].url : null) || 
              (sections[1]?.images && sections[1].images.length > 0 ? sections[1].images[0].url : null) || 
              (sections[2]?.images && sections[2].images.length > 0 ? sections[2].images[0].url : null) || 
              model.thumb
            : (model.colors && model.colors.length > 0) 
              ? model.colors[getRandomInt(0, model.colors.length)].carImage 
              : model.thumb
          } 
        />
      </div>
    </section>
  )}

  {(status === 'preorder') && (
    <section>
      <div class="container">
        <FeedbackForm 
          title="Забронировать новый JAC RF8"
        />
      </div>
    </section>
  )}

  {!!cars.length && (
    <section class="odd:bg-gray-100">
      <div class="container">
        <h2 class="text-center mobile-title-size sm:text-4xl mb-8 sm:mb-14"><Fragment set:html={`Автомобили ${model.mark_id}&nbsp;${model.name} в наличии в ${legal_city_where}`} /></h2>
        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-3 xl:grid-cols-4 gap-3 sm:gap-5 mt-5 car-list">
          {cars.map((car) => ( <CarItem car={car} /> ))}
        </div>
      </div>
    </section>
  )}
</Layout>
